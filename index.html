<html>
	<head>
		<title>Luftballons</title>
		<link href="stylesheet/styles.css" rel="stylesheet"/>
	</head>
	<body>
		<div class="mainscreen">
			<div id="playground" class="playground">
			</div>
			<div class="test">
			</div>
		</div>
		<script>
			const BALLOON_WIDTH = 80;
			const BALLOON_HEIGHT = 100;
			const MAX_BALLOONS = 5;
			const chars = ['A','B','C','D'];
			const char_areas = [];
			let  drawing_area;
			let  balloons=[];
			let ticks = 0;

			function init_balloons() {
				const playground = document.getElementById("playground");
				const canvas = document.createElement("canvas");
				const width = playground.offsetWidth - 10;
				const height = playground.offsetHeight - 10;
				canvas.width = width;
				canvas.height = height;
				playground.appendChild(canvas);
				drawing_area = {
					canvas:canvas,
					width:width,
					height:height
				};
			
				chars.forEach( (cur_char) => {
					char_areas.push( create_char_area(cur_char, canvas));
				});

				canvas.addEventListener("touchstart", on_touch);

				start_timer();

			};

			function on_touch(event){
				event.preventDefault();
				const touches = event.changedTouches;
				for( let i = 0; i<touches.length; i++) {
					balloons.forEach( (cur_balloon) =>{
						cur_balloon.hit(touches[i].pageX, touches[i].pageY);
					});
				};
			};


			function start_timer() {
				setTimeout(update_drawing_area, 30 ); 
			}

			function randomInt(max) {
				return Math.floor(Math.random() * max );

			};

			function random_x_pos(){
				return randomInt(drawing_area.width - BALLOON_WIDTH);
			};

			function create_char_area( text, canvas) {
				return {
					text:text,
					pos_x:0,
					pos_y:0,
					init: function(canvas){
						const context = canvas.getContext("2d");
						context.font = "48px serif";
						const area = context.measureText(this.text);
						this.pos_x = Math.floor((BALLOON_WIDTH - Math.floor(area.width))/2);
						const height = area.emHeightDescent; //area.emHeightAscent + area.emHeightDescent;
						this.pos_y = Math.floor((BALLOON_HEIGHT - Math.floor(height))/2) + 20;
						return this;
					}
				}.init(canvas);
			};

			function create_balloon(){
				const balloon = new Image();
				balloon.src = "images/redballoon.svg";
				const index = randomInt(char_areas.length - 1 );

				result = {
					image:balloon,
					text:char_areas[index],	
					pos_x:random_x_pos(),
					pos_y:drawing_area.height - BALLOON_HEIGHT,
					hit: function(x,y) {
						this.remove = (x>=this.pos_x) &&
							      (x<=this.pos_x + BALLOON_WIDTH) &&
							      (y>=this.pos_y) &&
							      (y<=this.pos_y + BALLOON_HEIGHT);	
					},
					remove:false
				};

				return result;
			};

			function update_drawing_area() {
				if((balloons.length<5) && (ticks % 50 == 0  ) ){
					balloons.push(create_balloon());
					ticks = 0;
				};

				ticks = ticks + 1;

				const tmp = [];

				balloons.forEach( (cur_balloon) => {
					cur_balloon.pos_y = cur_balloon.pos_y - 2;
					if( (cur_balloon.pos_y > 0) && (!cur_balloon.remove) ){
						tmp.push(cur_balloon);
					};
				});

				balloons = tmp;

				start_timer();
				requestAnimationFrame(draw);

			};
			

			function draw() {
				const canvas = drawing_area.canvas;
				if( canvas.getContext ){
					const ctx = canvas.getContext("2d");
					ctx.clearRect(0,0,drawing_area.width, drawing_area.height);
				
					balloons.forEach((cur_balloon) => {
						ctx.drawImage(cur_balloon.image, cur_balloon.pos_x, cur_balloon.pos_y, BALLOON_WIDTH, BALLOON_HEIGHT); 
						const txt = cur_balloon.text;
						ctx.fillStyle="white";
						ctx.font = "48px serif";

						ctx.fillText(txt.text, cur_balloon.pos_x+txt.pos_x, cur_balloon.pos_y +txt.pos_y);
					});
				}

			};
			window.addEventListener("load",init_balloons);
		</script>
	</body>
</html>
